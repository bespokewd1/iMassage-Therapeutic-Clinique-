---
import BaseLayout from 'src/layouts/BaseLayout.astro';
import CTA from '@components/CTA.astro';
import Landing from '@components/Landing.astro';
// Optimize our landing image and pass it as props to the BaseLayout (for preloading) and Landing (for rendering)
import { getOptimizedImage } from '@js/utils';
import landingImage from '@assets/images/landing.jpg'; // <-- THE PATH TO THE ASSET YOU WANT TO PRELOAD - The asset must live in src
import { getCollection } from 'astro:content';
const optimizedImage = await getOptimizedImage(landingImage);

const reviews = await getCollection('reviews');

// helper: initials from name
const getInitials = (name: string) => {
  if (!name) return '';
  const parts = name.trim().split(/\s+/);
  if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
  return (
    parts[0].charAt(0).toUpperCase() +
    parts[parts.length - 1].charAt(0).toUpperCase()
  );
};
---

<BaseLayout preloadedImage={optimizedImage}>
  <!-- ============================================ -->
  <!--                    LANDING                   -->
  <!-- ============================================ -->

  <Landing title="Reviews" image={optimizedImage} />

  <!-- ============================================ -->
  <!--                  Reviews                     -->
  <!-- ============================================ -->
  <!--
  <section id="reviews">
    <div class="container">
      <div class="review">
        <picture>
          <img
            class="profile"
            loading="lazy"
            decoding="async"
            src="/assets/svgs/profile.svg"
            alt=""
            width="99"
            height="99"
          />
        </picture>
        <p>
          Lorem ipsum dolor, sit amet consectetur adipisicing elit. Sed
          recusandae rerum unde similique ratione sapiente necessitatibus natus
          mollitia nam iusto.
        </p>
        <div class="star-group">
          <span class="name">B Miller<span class="desc">Homeowner</span></span>
          <picture>
            <img
              aria-hidden="true"
              loading="lazy"
              decoding="async"
              src="/assets/svgs/stars.svg"
              alt="stars"
              width="91"
              height="15"
            />
          </picture>
        </div>
      </div>
      <div class="review">
        <picture>
          <img
            class="profile"
            loading="lazy"
            decoding="async"
            src="/assets/svgs/profile.svg"
            alt=""
            width="99"
            height="99"
          />
        </picture>
        <p>
          Lorem ipsum dolor, sit amet consectetur adipisicing elit. Sed
          recusandae rerum unde similique ratione sapiente necessitatibus natus
          mollitia nam iusto.
        </p>
        <div class="star-group">
          <span class="name">Vincent M.<span class="desc">Homeowner</span></span
          >
          <picture>
            <img
              aria-hidden="true"
              loading="lazy"
              decoding="async"
              src="/assets/svgs/stars.svg"
              alt="stars"
              width="91"
              height="15"
            />
          </picture>
        </div>
      </div>
      <div class="review">
        <picture>
          <img
            class="profile"
            loading="lazy"
            decoding="async"
            src="/assets/svgs/profile.svg"
            alt=""
            width="99"
            height="99"
          />
        </picture>
        <p>
          Lorem ipsum dolor, sit amet consectetur adipisicing elit. Sed
          recusandae rerum unde similique ratione sapiente necessitatibus natus
          mollitia nam iusto.
        </p>
        <div class="star-group">
          <span class="name">Alex L.<span class="desc">Homeowner</span></span>
          <picture>
            <img
              aria-hidden="true"
              loading="lazy"
              decoding="async"
              src="/assets/svgs/stars.svg"
              alt="stars"
              width="91"
              height="15"
            />
          </picture>
        </div>
      </div>
      <div class="review">
        <picture>
          <img
            class="profile"
            loading="lazy"
            decoding="async"
            src="/assets/svgs/profile-woman.svg"
            alt=""
            width="99"
            height="99"
          />
        </picture>
        <p>
          Lorem ipsum dolor, sit amet consectetur adipisicing elit. Sed
          recusandae rerum unde similique ratione sapiente necessitatibus natus
          mollitia nam iusto.
        </p>
        <div class="star-group">
          <span class="name"
            >Arrieana M.<span class="desc">Homeowner</span></span
          >
          <picture>
            <img
              aria-hidden="true"
              loading="lazy"
              decoding="async"
              src="/assets/svgs/stars.svg"
              alt="stars"
              width="91"
              height="15"
            />
          </picture>
        </div>
      </div>
      <div class="review">
        <picture>
          <img
            class="profile"
            loading="lazy"
            decoding="async"
            src="/assets/svgs/profile.svg"
            alt=""
            width="99"
            height="99"
          />
        </picture>
        <p>
          Lorem ipsum dolor, sit amet consectetur adipisicing elit. Sed
          recusandae rerum unde similique ratione sapiente necessitatibus natus
          mollitia nam iusto.
        </p>
        <div class="star-group">
          <span class="name">Leo N.<span class="desc">Homeowner</span></span>
          <picture>
            <img
              aria-hidden="true"
              loading="lazy"
              decoding="async"
              src="/assets/svgs/stars.svg"
              alt="stars"
              width="91"
              height="15"
            />
          </picture>
        </div>
      </div>
      <div class="review">
        <picture>
          <img
            class="profile"
            loading="lazy"
            decoding="async"
            src="/assets/svgs/profile.svg"
            alt=""
            width="99"
            height="99"
          />
        </picture>
        <p>
          Lorem ipsum dolor, sit amet consectetur adipisicing elit. Sed
          recusandae rerum unde similique ratione sapiente necessitatibus natus
          mollitia nam iusto.
        </p>
        <div class="star-group">
          <span class="name">Brian A.<span class="desc">Homeowner</span></span>
          <picture>
            <img
              aria-hidden="true"
              loading="lazy"
              decoding="async"
              src="/assets/svgs/stars.svg"
              alt="stars"
              width="91"
              height="15"
            />
          </picture>
        </div>
      </div>
    </div>
  </section> -->

  <!-- ============================================ -->
  <!--                  Reviews                     -->
  <!-- ============================================ -->
  <section class="bg-orange-50 py-16 md:py-24">
    <div class="container mx-auto max-w-6xl px-4">
      <div
        class="grid gap-12 md:grid-cols-2 md:gap-10 lg:grid-cols-3 lg:gap-12"
      >
        {
          reviews.map(({ id, data }) => {
            const initials = getInitials(data.name);
            return (
              <article class="relative flex h-full flex-col rounded-md bg-orange-200/90 p-8 pt-12 shadow-md">
                {/* Avatar */}
                <div class="absolute -top-10 left-8">
                  {data.photo ? (
                    <img
                      src={data.photo.src}
                      alt={data.name}
                      class="h-20 w-20 rounded-full object-cover ring-4 ring-white dark:ring-slate-900"
                      loading="lazy"
                      decoding="async"
                    />
                  ) : (
                    <div
                      class="flex h-20 w-20 items-center justify-center rounded-full bg-emerald-200 text-xl font-semibold text-emerald-900 ring-4 ring-white dark:ring-slate-900"
                      aria-hidden="true"
                    >
                      {initials}
                    </div>
                  )}
                </div>

                {/* Review text */}
                <p class="mt-4 text-sm leading-relaxed text-slate-900">
                  {data.reviewText}
                </p>

                {/* Stars */}
                <div class="mt-4 mb-3 flex justify-start gap-1">
                  {Array.from({ length: 5 }, (_, s) => (
                    <svg
                      class:list={[
                        'h-4 w-5',
                        s < data.rating
                          ? 'fill-[#FFA500] text-[#FFA500]'
                          : 'fill-gray-300 text-gray-300',
                      ]}
                      viewBox="0 0 20 20"
                      xmlns="http://www.w3.org/2000/svg"
                      aria-hidden="true"
                    >
                      <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z" />
                    </svg>
                  ))}
                </div>

                {/* Name + desc */}
                <div class="mt-auto flex items-center justify-between border-t border-slate-700 pt-4 dark:border-slate-700">
                  <div>
                    <span class="block text-sm font-semibold text-slate-900">
                      {data.name}
                    </span>
                    {data.desc && (
                      <span class="block text-xs text-slate-500">
                        {data.desc}
                      </span>
                    )}
                  </div>
                  {data.href && (
                    <a
                      href={data.href}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="text-xs font-medium text-emerald-600 hover:text-emerald-700"
                    >
                      View review
                    </a>
                  )}
                </div>
              </article>
            );
          })
        }
      </div>
    </div>
  </section>

  <CTA
    title="Restore Balance. Feel Renewed"
    description="Expert therapeutic massage tailored to your needs."
  />
</BaseLayout>

<style lang="less">
  /* PAGE-SPECIFIC STYLES FOR THE REVIEWS PAGE */

  /*-- -------------------------- -->
<---           Reviews          -->
<--- -------------------------- -*/

  /* Mobile */
  @media only screen and (min-width: 0em) {
    #reviews {
      margin: auto;
      padding-top: (120/16rem);
      padding-bottom: (50/16rem);

      .container {
        width: 96%;
        max-width: (1320/16rem);
      }

      .review {
        width: 100%;
        max-width: (410/16rem);
        margin: auto;
        margin-bottom: (100/16rem);
        padding: (64/16rem) (30/16rem) (18/16rem) (30/16rem);
        background: #fff;
        box-shadow: 0px 20px 40px rgba(0, 0, 0, 0.05);
        border-radius: (5/16rem);
        display: flex;
        flex-direction: column;
        position: relative;
        &:last-of-type {
          margin-bottom: 0;
        }

        .profile {
          width: (99/16rem);
          height: (99/16rem);
          margin-bottom: (16/16rem);
          margin-left: 0;
          border-radius: 50%;
          display: block;
          position: absolute;
          top: (-51/16rem);
          left: (30/16rem);
        }

        p {
          line-height: 1.5em;
          text-align: left;
          margin-bottom: (28/16rem);
        }

        .star-group {
          margin-top: auto;
          padding-top: (16/16rem);
          border-top: 1px solid #e7e7e7;
          display: flex;
          justify-content: space-between;
          align-items: center;
          flex-wrap: nowrap;

          .name {
            font-weight: bold;
            line-height: (24/16rem);
            text-align: left;
            color: #1a1a1a;
            display: block;
          }

          .desc {
            font-weight: 400;
            color: #575757;
            display: block;
          }

          img {
            width: (91/16rem);
            height: (15/16rem);
            margin: 0;
            display: block;
          }
        }
      }
    }
  }

  /* Tablet */
  @media only screen and (min-width: 48em) {
    #reviews {
      padding-top: (150/16rem);
      padding-bottom: (50/16rem);

      .container {
        font-size: ~'min(1.4vw, 1em)';
        padding: 0;
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        column-gap: (30/16rem);
      }

      .review {
        margin: 0;
        margin-bottom: (150/16rem);

        &:last-of-type {
          margin-bottom: (150/16rem);
        }
      }
    }
  }

  /* Dark Mode */
  @media only screen and (min-width: 0em) {
    body.dark-mode {
      #reviews {
        .review {
          background: var(--medium);

          .star-group {
            .name {
              color: #fff;
            }

            .desc {
              color: #fff;
              opacity: 0.7;
            }
          }
        }
      }
    }
  }
</style>
